# 后端连接问题排查指南

## 问题：添加失败 - 后端未连接

### 快速检查

1. **检查后端是否运行**
   ```bash
   npm run check-backend
   ```

2. **检查端口占用**
   ```bash
   lsof -i:5000
   ```

3. **启动后端服务器**
   ```bash
   npm run server
   ```

### 常见问题及解决方案

#### 1. 后端服务器未启动

**症状**: 浏览器控制台显示 `ECONNREFUSED` 或 `Network Error`

**解决**:
```bash
# 启动后端服务器
npm run server

# 或同时启动前后端
npm run dev
```

#### 2. 端口被占用

**症状**: 启动后端时提示 `EADDRINUSE: address already in use :::5000`

**解决**:
```bash
# 方法1: 使用清理脚本
npm run kill-port

# 方法2: 手动清理
kill -9 $(lsof -ti:5000)

# 方法3: 更改端口（修改 .env 文件）
PORT=5001
```

#### 3. 数据库连接失败

**症状**: 后端启动但数据库操作失败

**解决**:
```bash
# 测试数据库连接
npm run test-db

# 检查 .env 文件配置
cat .env
```

#### 4. CORS 跨域问题

**症状**: 浏览器控制台显示 CORS 错误

**解决**: 
- 检查 `server/index.js` 中是否启用了 CORS 中间件
- 确保前端请求的 URL 正确

### 调试步骤

1. **检查后端日志**
   - 启动后端后，查看终端输出
   - 应该看到 "服务器运行在端口 5000" 和 "数据库连接成功"

2. **测试 API 端点**
   ```bash
   # 健康检查
   curl http://localhost:5000/api/health
   
   # 应该返回: {"status":"OK","message":"服务器运行正常"}
   ```

3. **检查浏览器控制台**
   - 打开浏览器开发者工具 (F12)
   - 查看 Console 和 Network 标签
   - 查看是否有错误信息

4. **检查前端 API 配置**
   - 打开 `client/src/api/transactions.js`
   - 确认 `API_BASE_URL` 为 `http://localhost:5000/api`

### 完整启动流程

```bash
# 1. 确保数据库已初始化
npm run test-db

# 2. 清理端口（如果需要）
npm run kill-port

# 3. 启动项目（同时启动前后端）
npm run dev

# 或者分别启动：
# 终端1: npm run server
# 终端2: npm run client
```

### 验证连接

启动后，在浏览器中：
1. 打开 http://localhost:3000
2. 打开开发者工具 (F12)
3. 查看 Network 标签
4. 尝试添加一条记录
5. 查看请求是否发送到 `http://localhost:5000/api/transactions`

### 如果仍然无法连接

1. 检查防火墙设置
2. 检查是否有代理设置影响
3. 查看后端终端是否有错误信息
4. 检查 `.env` 文件配置是否正确

