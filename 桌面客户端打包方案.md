# æ¡Œé¢å®¢æˆ·ç«¯æ‰“åŒ…æ–¹æ¡ˆ

## ğŸ“¦ æ–¹æ¡ˆæ¦‚è¿°

å°†è®°è´¦ç³»ç»Ÿæ‰“åŒ…æˆå¯å®‰è£…çš„æ¡Œé¢åº”ç”¨ï¼ˆ.dmg for Mac, .exe for Windowsï¼‰ï¼Œç”¨æˆ·æ— éœ€å®‰è£… Node.jsã€MySQL ç­‰ç¯å¢ƒï¼Œç›´æ¥åŒå‡»å®‰è£…å³å¯ä½¿ç”¨ã€‚

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šElectron + SQLite

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹æ¡ˆï¼Ÿ

1. **Electron**ï¼šæˆç†Ÿçš„æ¡Œé¢åº”ç”¨æ¡†æ¶ï¼ˆVS Codeã€Slack ç­‰éƒ½åœ¨ç”¨ï¼‰
2. **SQLite**ï¼šè½»é‡çº§æ•°æ®åº“ï¼Œæ— éœ€å®‰è£… MySQL
   - æ•°æ®åº“æ–‡ä»¶ç›´æ¥æ‰“åŒ…åœ¨åº”ç”¨ä¸­
   - æ— éœ€ç”¨æˆ·é…ç½®æ•°æ®åº“
   - è·¨å¹³å°å…¼å®¹æ€§å¥½

### æ¶æ„å˜åŒ–

```
å½“å‰æ¶æ„ï¼š
æµè§ˆå™¨ â†’ React å‰ç«¯ â†’ Express åç«¯ â†’ MySQL æ•°æ®åº“

æ¡Œé¢åº”ç”¨æ¶æ„ï¼š
Electron çª—å£ â†’ React å‰ç«¯ â†’ Express åç«¯ï¼ˆå†…ç½®ï¼‰ â†’ SQLite æ•°æ®åº“ï¼ˆæ–‡ä»¶ï¼‰
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šå®‰è£… Electron ä¾èµ–

```bash
npm install --save-dev electron electron-builder concurrently wait-on
npm install better-sqlite3
```

### æ­¥éª¤ 2ï¼šåˆ›å»º Electron ä¸»è¿›ç¨‹æ–‡ä»¶

åˆ›å»º `electron/main.js`ï¼š

```javascript
const { app, BrowserWindow } = require('electron');
const path = require('path');
const { spawn } = require('child_process');
const isDev = process.env.NODE_ENV === 'development';

let mainWindow;
let serverProcess;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
    },
    icon: path.join(__dirname, '../assets/icon.png'), // åº”ç”¨å›¾æ ‡
  });

  // å¼€å‘ç¯å¢ƒï¼šè¿æ¥åˆ° React å¼€å‘æœåŠ¡å™¨
  if (isDev) {
    mainWindow.loadURL('http://localhost:3000');
    mainWindow.webContents.openDevTools();
  } else {
    // ç”Ÿäº§ç¯å¢ƒï¼šåŠ è½½æ‰“åŒ…åçš„ React åº”ç”¨
    mainWindow.loadFile(path.join(__dirname, '../client/build/index.html'));
  }

  mainWindow.on('closed', () => {
    mainWindow = null;
  });
}

function startServer() {
  const serverPath = path.join(__dirname, '../server/index.js');
  serverProcess = spawn('node', [serverPath], {
    cwd: path.join(__dirname, '..'),
    env: { ...process.env, NODE_ENV: 'production' },
  });

  serverProcess.stdout.on('data', (data) => {
    console.log(`æœåŠ¡å™¨: ${data}`);
  });

  serverProcess.stderr.on('data', (data) => {
    console.error(`æœåŠ¡å™¨é”™è¯¯: ${data}`);
  });
}

app.whenReady().then(() => {
  startServer();
  // ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
  setTimeout(() => {
    createWindow();
  }, 2000);

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (serverProcess) {
    serverProcess.kill();
  }
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('before-quit', () => {
  if (serverProcess) {
    serverProcess.kill();
  }
});
```

### æ­¥éª¤ 3ï¼šä¿®æ”¹ package.json

åœ¨æ ¹ç›®å½• `package.json` æ·»åŠ ï¼š

```json
{
  "main": "electron/main.js",
  "scripts": {
    "electron": "electron .",
    "electron:dev": "NODE_ENV=development concurrently \"npm run server\" \"npm run client\" \"wait-on http://localhost:3000 && electron .\"",
    "electron:build": "npm run build && electron-builder",
    "build": "cd client && npm run build"
  },
  "build": {
    "appId": "com.accounting.app",
    "productName": "è®°è´¦ç³»ç»Ÿ",
    "directories": {
      "output": "dist"
    },
    "files": [
      "electron/**/*",
      "server/**/*",
      "client/build/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "mac": {
      "icon": "assets/icon.icns",
      "category": "public.app-category.finance"
    },
    "win": {
      "icon": "assets/icon.ico",
      "target": "nsis"
    },
    "linux": {
      "icon": "assets/icon.png",
      "target": "AppImage"
    }
  }
}
```

### æ­¥éª¤ 4ï¼šå‡†å¤‡ SQLite æ•°æ®åº“

#### 4.1 å®‰è£… SQLite é©±åŠ¨

```bash
npm install better-sqlite3
```

#### 4.2 åˆ›å»º SQLite æ•°æ®åº“é€‚é…å™¨

åˆ›å»º `server/config/database-sqlite.js`ï¼š

```javascript
const Database = require('better-sqlite3');
const path = require('path');
const { app } = require('electron');
const fs = require('fs');

// è·å–ç”¨æˆ·æ•°æ®ç›®å½•
const userDataPath = app ? app.getPath('userData') : path.join(__dirname, '../../data');
const dbPath = path.join(userDataPath, 'accounting.db');

// ç¡®ä¿ç›®å½•å­˜åœ¨
if (!fs.existsSync(userDataPath)) {
  fs.mkdirSync(userDataPath, { recursive: true });
}

// åˆ›å»ºæ•°æ®åº“è¿æ¥
const db = new Database(dbPath);

// å¯ç”¨å¤–é”®çº¦æŸ
db.pragma('foreign_keys = ON');

// å°† MySQL è¯­æ³•è½¬æ¢ä¸º SQLite å…¼å®¹è¯­æ³•
function mysqlToSqlite(sql) {
  return sql
    .replace(/AUTO_INCREMENT/gi, 'AUTOINCREMENT')
    .replace(/INT AUTO_INCREMENT/gi, 'INTEGER PRIMARY KEY AUTOINCREMENT')
    .replace(/TIMESTAMP DEFAULT CURRENT_TIMESTAMP/gi, 'DATETIME DEFAULT CURRENT_TIMESTAMP')
    .replace(/ENGINE=InnoDB/gi, '')
    .replace(/DEFAULT CHARSET=utf8mb4/gi, '')
    .replace(/COLLATE utf8mb4_unicode_ci/gi, '')
    .replace(/ENUM\([^)]+\)/gi, 'TEXT'); // ENUM è½¬ä¸º TEXT
}

module.exports = {
  db,
  mysqlToSqlite,
  dbPath
};
```

#### 4.3 åˆå§‹åŒ–è„šæœ¬

- å°†ç°æœ‰å»ºè¡¨ SQL è½¬æ¢ä¸º SQLite è¯­æ³•ï¼ˆå¯å¤ç”¨ `mysqlToSqlite` å¸®åŠ©å‡½æ•°ï¼‰
- åœ¨ Electron å¯åŠ¨é˜¶æ®µæ£€æµ‹ `app.getPath('userData')` ä¸‹æ˜¯å¦å­˜åœ¨ `accounting.db`ï¼Œè‹¥æ— åˆ™å¤åˆ¶å†…ç½®ç§å­æ•°æ®åº“
- åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨ Express/API æœåŠ¡ï¼Œç¡®ä¿å‰ç«¯æ¸²æŸ“å‰æ•°æ®åº“å°±ç»ª

---

## ğŸ“‹ å®æ–½æ¸…å•

1. **Electron Shell**ï¼šæŒ‰ç…§æ­¥éª¤ 1~3 å®Œæˆä¸»è¿›ç¨‹ã€è„šæœ¬ä¸æ‰“åŒ…é…ç½®ã€‚
2. **SQLite è¿è¡Œç¯å¢ƒ**ï¼š
   - åœ¨ `electron/resources/` ä¸­å­˜æ”¾ä¸€ä»½åˆå§‹ `accounting.db`
   - Electron å¯åŠ¨æ—¶æ‹·è´åˆ° `app.getPath('userData')`
3. **åç«¯æ”¹é€ **ï¼š
   - ç»Ÿä¸€å¼•ç”¨ `database-sqlite.js`
   - å°†æ‰¹é‡ SQL æˆ–è¿ç§»è„šæœ¬è½¬æ¢ä¸º SQLite è¯­æ³•
4. **æ‰“åŒ…éªŒè¯**ï¼š
   - `npm run electron:dev` éªŒè¯æ¡Œé¢ç«¯æµç¨‹
   - `npm run electron:build` ç”Ÿæˆ `.dmg`
   - `npm run electron:build:win` / `electron:build:linux` åœ¨å¯¹åº”ç³»ç»Ÿæˆ– CI ä¸­æ‰§è¡Œ

---

## ğŸ¤– GitHub Actions CI

ä»“åº“å·²ç»å†…ç½® `.github/workflows/electron-build.yml`ï¼š

- **è§¦å‘æ¡ä»¶**ï¼šæ¨é€åˆ° `main`ã€PRã€æ‰‹åŠ¨è§¦å‘
- **macOS Job**ï¼š`npm run electron:build` ç”Ÿæˆ `.dmg`ï¼Œäº§ç‰©ä¸Šä¼ ä¸º `mac-dist`
- **Windows Job**ï¼š`npm run electron:build:win` åœ¨çœŸæ­£çš„ Windows Runner ç¼–è¯‘ `better-sqlite3`ï¼Œäº§ç‰©ä¸Šä¼ ä¸º `win-dist`
- **æ— ç­¾å**ï¼šé»˜è®¤ä¸åšä»£ç ç­¾åï¼Œå¯åœ¨éœ€è¦æ—¶è‡ªè¡Œæ·»åŠ è¯ä¹¦/secret

å¦‚éœ€ Linux åŒ…ï¼Œå¯å¤åˆ¶ workflow ä¸­çš„ç»“æ„åŠ ä¸€ä¸ª `ubuntu-latest` jobï¼Œæ‰§è¡Œ `npm run electron:build:linux`ã€‚

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

```bash
# å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆReact + Node + Electronï¼‰
npm run electron:dev

# ä»…æ„å»ºå‰ç«¯ï¼ˆä¾› Electron ç”Ÿäº§åŒ…ä½¿ç”¨ï¼‰
npm run build

# æ‰“åŒ…å½“å‰å¹³å°
npm run electron:build
```

Windows / Linux å®‰è£…åŒ…éœ€è¦åœ¨å¯¹åº”å¹³å°è¿è¡Œ `electron-builder`ï¼Œæˆ–ä½¿ç”¨ CIï¼ˆGitHub Actionsã€CircleCI ç­‰ï¼‰åˆ†åˆ«è§¦å‘ã€‚

---

## ğŸ“¦ æ‰“åŒ…è¾“å‡º

æ‰“åŒ…åä¼šç”Ÿæˆï¼š

- **Mac**: `dist/è®°è´¦ç³»ç»Ÿ-1.0.0.dmg`
- **Windows**: `dist/è®°è´¦ç³»ç»Ÿ Setup 1.0.0.exe`
- **Linux**: `dist/è®°è´¦ç³»ç»Ÿ-1.0.0.AppImage`

---

## ğŸ’¡ æç¤º

- å°†æ•°æ®åº“è®¿é—®é›†ä¸­åœ¨ `server/config/database-sqlite.js`ï¼Œæ–¹ä¾¿åç»­æ‰©å±•äº‘åŒæ­¥æˆ–å¤‡ä»½åŠŸèƒ½
- Windows å®‰è£…åŒ…å»ºè®®åœ¨ Windows æœºå™¨/CI ç¼–è¯‘ï¼Œé¿å…åŸç”Ÿæ¨¡å—äº¤å‰ç¼–è¯‘é—®é¢˜
- æ‰“åŒ…å‰æ‰§è¡Œ `npm run build`ï¼Œç¡®ä¿ `client/build` å·²åŒ…å«æœ€æ–°é™æ€æ–‡ä»¶
- ä¸ºç§å­æ•°æ®åº“æä¾›å¯¼å…¥/å¯¼å‡ºè„šæœ¬ï¼Œä¾¿äºç”¨æˆ·è¿ç§»åˆ°å…¶ä»–è®¾å¤‡

---

## ğŸ“š å‚è€ƒèµ„æº

- [Electron å®˜æ–¹æ–‡æ¡£](https://www.electronjs.org/)
- [electron-builder æ–‡æ¡£](https://www.electron.build/)
- [better-sqlite3 æ–‡æ¡£](https://github.com/WiseLibs/better-sqlite3)

---

## â“ éœ€è¦å¸®åŠ©ï¼Ÿ

æˆ‘å¯ä»¥ååŠ©ï¼š
1. âœ… ä¼˜åŒ– Electron é…ç½®ä¸å®‰å…¨ç­–ç•¥
2. âœ… å®Œæˆ SQLite æ¥å…¥ä¸æ•°æ®è¿ç§»è„šæœ¬
3. âœ… é…ç½®å¤šå¹³å°æ‰“åŒ…æµæ°´çº¿
4. âœ… è®¾è®¡åˆå§‹åŒ–æ•°æ®/å¤‡ä»½æ–¹æ¡ˆ

å‘Šè¯‰æˆ‘ä½ çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é˜¶æ®µæ¨è¿›ã€‚

